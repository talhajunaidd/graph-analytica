variables:
#POSTGRES_DB: database_name

# This is a basic example for a gem or script which doesn't use
# services such as redis or postgres

.node: &node
    image: node:10
    before_script:
    - npm install
    cache:
        key: "$CI_COMMIT_REF_NAME"
        paths:
        - node_modules/

before_script:
# Print out python version for debugging
- python3 -V
#- apt-get update -q && apt-get install nodejs -yqq

stages:
- restore-packages
- build
- deploy

restore-pip-packages:
    tags:
    - graph-analytica
    stage: restore-packages
    script:
    - pip3 install -r requirements.txt

build:
#    tags:
#    - graph-analytica
    stage: build
    <<: *node
    script:
    - npm install
    - npm run build-prod
    artifacts:
        paths:
        - dist/
deploy:
    tags:
    - graph-analytica
    stage: deploy
    dependencies:
    - build
    environment:
        name: production
        url: http://graphanalytica.tk
    only:
    - master
    artifacts:
        paths:
        - graphanalytica core
    script:
    - python3 manage.py collectstatic --noinput
    - sudo cp -r static/ graphanalytica/ core/ /var/www/graphanalytica/
